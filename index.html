<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corrected EMI Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f7f7f7; padding: 40px; display: flex; justify-content: center; }
    .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
    input, select, button { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
    th { background-color: #f2f2f2; }
    .summary { background-color: #e9f5ff; padding: 15px; border-radius: 10px; margin-top: 20px; }
    .note { text-align: center; margin-top: 10px; font-size: 0.9rem; color: #777; }
  </style>
</head>
<body>
  <div class="container">
    <h2>EMI Calculator (Corrected Logic)</h2>
    <label>Loan Amount (₹):</label>
    <input type="number" id="loanAmount">
    <label>Interest Type:</label>
    <select id="interestType">
      <option value="reducing">Reducing</option>
      <option value="flat">Flat</option>
    </select>
    <label>Annual Interest Rate (%):</label>
    <input type="number" id="annualRate" step="0.01">
    <label>Gross Tenure (months):</label>
    <input type="number" id="grossTenure">
    <label>Advance EMI (count):</label>
    <input type="number" id="advanceEMI">
    <label>Disbursal Date:</label>
    <input type="date" id="disbursalDate">
    <label>First EMI Date:</label>
    <input type="date" id="firstEmiDate">
    <button onclick="calculateEMI()">Calculate</button>
    <div id="results" class="summary"></div>
    <div id="schedule"></div>
    <div class="note">Note: The calculation is for illustration purposes only. Actual values may vary.</div>
  </div>

  <script>
    function formatINR(val) {
      return "₹" + val.toLocaleString("en-IN", { minimumFractionDigits: 2 });
    }

    function calculateEMI() {
      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const interestType = document.getElementById('interestType').value;
      const annualRate = parseFloat(document.getElementById('annualRate').value);
      const grossTenure = parseInt(document.getElementById('grossTenure').value);
      const advanceEMI = parseInt(document.getElementById('advanceEMI').value);
      const disbursalDate = new Date(document.getElementById('disbursalDate').value);
      const firstEmiDate = new Date(document.getElementById('firstEmiDate').value);

      const netTenure = grossTenure - advanceEMI;
      const monthlyRate = annualRate / 1200;

      // First, calculate EMI on full loan to get advance payment
      let tempEMI = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, netTenure) / (Math.pow(1 + monthlyRate, netTenure) - 1);
      let advancePayment = tempEMI * advanceEMI;

      // Adjust loan for advance payment to get net disbursed
      const netLoan = loanAmount - advancePayment;

      // Now recalculate EMI correctly on netLoan
      let EMI;
      if (interestType === 'reducing') {
        EMI = netLoan * monthlyRate * Math.pow(1 + monthlyRate, netTenure) / (Math.pow(1 + monthlyRate, netTenure) - 1);
      } else {
        let flatInterest = (netLoan * (annualRate / 100) * grossTenure) / 12;
        EMI = (netLoan + flatInterest) / grossTenure;
      }

      // Broken period interest
      const diffDays = Math.ceil((firstEmiDate - disbursalDate) / (1000 * 60 * 60 * 24));
      const brokenInterest = (netLoan * (annualRate / 100) * diffDays) / 365;
      const firstEMI = EMI + brokenInterest;

      const lastEmiDate = new Date(firstEmiDate);
      lastEmiDate.setMonth(lastEmiDate.getMonth() + netTenure - 1);

      let summary = `
        <h3>Loan Summary</h3>
        <p><strong>Gross Loan Amount:</strong> ${formatINR(loanAmount)}</p>
        <p><strong>Advance EMI Count:</strong> ${advanceEMI}</p>
        <p><strong>Advance EMI Value:</strong> ${formatINR(advancePayment)}</p>
        <p><strong>Net Disbursed Amount:</strong> ${formatINR(netLoan)}</p>
        <p><strong>EMI (Regular):</strong> ${formatINR(EMI)}</p>
        <p><strong>Broken Period Interest:</strong> ${formatINR(brokenInterest)}</p>
        <p><strong>First EMI:</strong> ${formatINR(firstEMI)}</p>
        <p><strong>First EMI Date:</strong> ${firstEmiDate.toDateString()}</p>
        <p><strong>Last EMI Date:</strong> ${lastEmiDate.toDateString()}</p>
      `;
      document.getElementById('results').innerHTML = summary;

      let balance = netLoan;
      let table = `<h3>Amortization Schedule</h3><table><tr><th>Month</th><th>Principal</th><th>Interest</th><th>EMI</th><th>Balance</th></tr>`;
      for (let i = 0; i < netTenure; i++) {
        let interest = interestType === 'reducing' ? balance * monthlyRate : (netLoan * (annualRate / 100)) / 12;
        let principal = EMI - interest;
        balance -= principal;
        table += `<tr><td>${i + 1}</td><td>${principal.toFixed(2)}</td><td>${interest.toFixed(2)}</td><td>${EMI.toFixed(2)}</td><td>${Math.max(0, balance).toFixed(2)}</td></tr>`;
      }
      table += `</table>`;
      document.getElementById('schedule').innerHTML = table;
    }
  </script>
</body>
</html>
